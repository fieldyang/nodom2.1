{"code":"import { ModuleFactory } from \"./modulefactory\";\r\n/**\r\n * 消息类\r\n */\r\nexport class Message {\r\n    /**\r\n     * @param fromModule \t来源模块id\r\n     * @param toModule \t\t目标模块id或名字\r\n     * @param content \t\t消息内容\r\n     * @param parentId      父模块id\r\n     */\r\n    constructor(fromModule, toModule, content, parentId) {\r\n        this.fromModule = fromModule;\r\n        this.toModule = toModule;\r\n        this.content = content;\r\n        this.parentId = parentId;\r\n    }\r\n}\r\n/**\r\n * 消息队列\r\n */\r\nexport class MessageQueue {\r\n    /**\r\n     * 添加消息到消息队列\r\n     * @param fromModule \t来源模块名\r\n     * @param toModule \t\t目标模块名\r\n     * @param content \t\t消息内容\r\n     * @param parentId      父模块消息\r\n     */\r\n    static add(from, to, data, parentId) {\r\n        if (parentId) {\r\n            this.noOwnerNMessages.push(new Message(from, to, data, parentId));\r\n        }\r\n        else {\r\n            this.messages.push(new Message(from, to, data));\r\n        }\r\n    }\r\n    /**\r\n     * 从 no owner队列移动到 待发队列\r\n     * @param moduleName    模块名\r\n     * @param moduleId      模块id\r\n     * @param parentId      父模块id\r\n     */\r\n    static move(moduleName, moduleId, parentId) {\r\n        let index;\r\n        while ((index = this.noOwnerNMessages.findIndex(item => item.parentId === parentId && moduleName === item.toModule)) !== -1) {\r\n            let msg = this.noOwnerNMessages[index];\r\n            //从noowner数组移除\r\n            this.noOwnerNMessages.splice(index, 1);\r\n            msg.toModule = moduleId;\r\n            delete msg.parentId;\r\n            //加入待发队列\r\n            this.messages.push(msg);\r\n        }\r\n    }\r\n    /**\r\n     * 处理消息队列\r\n     */\r\n    static handleQueue() {\r\n        for (let i = 0; i < this.messages.length; i++) {\r\n            let msg = this.messages[i];\r\n            let module = ModuleFactory.get(msg.toModule);\r\n            // 模块状态未激活或激活才接受消息\r\n            if (module && module.state >= 2) {\r\n                module.receive(msg.fromModule, msg.content);\r\n                // 清除已接受消息，或已死亡模块的消息\r\n                MessageQueue.messages.splice(i--, 1);\r\n            }\r\n        }\r\n    }\r\n}\r\n/**\r\n * 消息数组\r\n */\r\nMessageQueue.messages = [];\r\nMessageQueue.noOwnerNMessages = [];\r\n//# sourceMappingURL=messagequeue.js.map","references":["D:/graduate/project/nodom2.1/nodom2.1/core/module.ts","D:/graduate/project/nodom2.1/nodom2.1/core/modulefactory.ts"],"map":"{\"version\":3,\"file\":\"messagequeue.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../core/messagequeue.ts\"],\"names\":[],\"mappings\":\"AACA,OAAO,EAAE,aAAa,EAAE,MAAM,iBAAiB,CAAC;AAEhD;;GAEG;AACH,MAAM,OAAO,OAAO;IAqBhB;;;;;OAKG;IACH,YAAY,UAAkB,EAAE,QAAuB,EAAE,OAAY,EAAC,QAAgB;QAClF,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;QAC7B,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;QACzB,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;IAC7B,CAAC;CACJ;AACD;;GAEG;AACH,MAAM,OAAO,YAAY;IAOrB;;;;;;OAMG;IACI,MAAM,CAAC,GAAG,CAAC,IAAY,EAAE,EAAiB,EAAE,IAAS,EAAC,QAAiB;QAC1E,IAAG,QAAQ,EAAC;YACR,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,IAAI,OAAO,CAAC,IAAI,EAAC,EAAE,EAAC,IAAI,EAAC,QAAQ,CAAC,CAAC,CAAC;SAClE;aAAI;YACD,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,OAAO,CAAC,IAAI,EAAE,EAAE,EAAE,IAAI,CAAC,CAAC,CAAC;SACnD;IACL,CAAC;IAED;;;;;OAKG;IACI,MAAM,CAAC,IAAI,CAAC,UAAiB,EAAC,QAAe,EAAC,QAAe;QAChE,IAAI,KAAK,CAAC;QACV,OAAM,CAAC,KAAK,GAAG,IAAI,CAAC,gBAAgB,CAAC,SAAS,CAAC,IAAI,CAAA,EAAE,CAAA,IAAI,CAAC,QAAQ,KAAG,QAAQ,IAAI,UAAU,KAAK,IAAI,CAAC,QAAQ,CAAC,CAAC,KAAG,CAAC,CAAC,EAAC;YACjH,IAAI,GAAG,GAAW,IAAI,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;YAC/C,cAAc;YACd,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC,KAAK,EAAC,CAAC,CAAC,CAAC;YACtC,GAAG,CAAC,QAAQ,GAAG,QAAQ,CAAC;YACxB,OAAO,GAAG,CAAC,QAAQ,CAAC;YACpB,QAAQ;YACR,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;SAC3B;IACL,CAAC;IAED;;OAEG;IACI,MAAM,CAAC,WAAW;QACrB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;YAC3C,IAAI,GAAG,GAAY,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;YACpC,IAAI,MAAM,GAAW,aAAa,CAAC,GAAG,CAAS,GAAG,CAAC,QAAQ,CAAC,CAAC;YAC7D,kBAAkB;YAClB,IAAI,MAAM,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC,EAAE;gBAC7B,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,UAAU,EAAE,GAAG,CAAC,OAAO,CAAC,CAAC;gBAC5C,oBAAoB;gBACpB,YAAY,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC;aACxC;SACJ;IACL,CAAC;;AAtDD;;GAEG;AACI,qBAAQ,GAAkB,EAAE,CAAC;AAE7B,6BAAgB,GAAkB,EAAE,CAAC\"}","dts":{"name":"D:/graduate/project/nodom2.1/nodom2.1/node_modules/.cache/rollup-plugin-typescript2/placeholder/core/messagequeue.d.ts","writeByteOrderMark":false,"text":"/**\r\n * 消息类\r\n */\r\nexport declare class Message {\r\n    /**\r\n     * 来源模块id\r\n     */\r\n    fromModule: number;\r\n    /**\r\n     * 目标模块id 或 名字\r\n     */\r\n    toModule: number | string;\r\n    /**\r\n     * 来源模块父id，当 toModule 为模块名时需要\r\n     */\r\n    parentId: number;\r\n    /**\r\n     * 消息内容\r\n     */\r\n    content: any;\r\n    /**\r\n     * @param fromModule \t来源模块id\r\n     * @param toModule \t\t目标模块id或名字\r\n     * @param content \t\t消息内容\r\n     * @param parentId      父模块id\r\n     */\r\n    constructor(fromModule: number, toModule: number | string, content: any, parentId?: number);\r\n}\r\n/**\r\n * 消息队列\r\n */\r\nexport declare class MessageQueue {\r\n    /**\r\n     * 消息数组\r\n     */\r\n    static messages: Array<Message>;\r\n    static noOwnerNMessages: Array<Message>;\r\n    /**\r\n     * 添加消息到消息队列\r\n     * @param fromModule \t来源模块名\r\n     * @param toModule \t\t目标模块名\r\n     * @param content \t\t消息内容\r\n     * @param parentId      父模块消息\r\n     */\r\n    static add(from: number, to: number | string, data: any, parentId?: number): void;\r\n    /**\r\n     * 从 no owner队列移动到 待发队列\r\n     * @param moduleName    模块名\r\n     * @param moduleId      模块id\r\n     * @param parentId      父模块id\r\n     */\r\n    static move(moduleName: string, moduleId: number, parentId: number): void;\r\n    /**\r\n     * 处理消息队列\r\n     */\r\n    static handleQueue(): void;\r\n}\r\n"}}
